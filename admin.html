<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | ChatMate</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <style>
        :root { --primary: #00d2ff; --bg: #020617; --card: #0f172a; --text: #f8fafc; --success: #10b981; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; }
        
        /* Notification Section */
        .notif-panel { background: var(--card); padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--primary); }
        .notif-panel h3 { margin-bottom: 15px; color: var(--primary); }
        .notif-form { display: flex; flex-direction: column; gap: 10px; }
        .notif-form input, .notif-form textarea, .notif-form select {
            background: #020617; border: 1px solid #1e293b; color: white; padding: 12px; border-radius: 8px; outline: none;
        }
        .btn-group { display: flex; gap: 10px; }
        .btn-send { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-all { background: var(--success); color: white; }

        /* User Table */
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 15px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: rgba(255,255,255,0.02); color: var(--primary); }
        .user-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <h1>Admin Dashboard</h1>

    <div class="notif-panel">
        <h3><i class="fas fa-paper-plane"></i> Send Push Notification</h3>
        <div class="notif-form">
            <select id="target-user">
                <option value="all">Send to Everyone (Broadcast)</option>
                </select>
            <input type="text" id="notif-title" placeholder="Notification Title (e.g. System Update)">
            <textarea id="notif-body" rows="3" placeholder="Message content..."></textarea>
            <div class="btn-group">
                <button class="btn-send" onclick="sendPush()">Send Notification</button>
            </div>
        </div>
    </div>

    <h3>All Users</h3>
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Phone</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="user-table-body"></tbody>
    </table>

    <script>
        let allUsers = [];

        async function initAdmin() {
            const { data: users } = await _sb.from('users').select('*');
            if (!users) return;
            allUsers = users;

            // টেবিল লোড করা
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td style="display:flex; align-items:center; gap:10px;">
                        <img src="${user.avatar_url || 'default.png'}" class="user-img">
                        ${user.name}
                    </td>
                    <td>${user.phone}</td>
                    <td>
                        <button onclick="setTarget('${user.phone}')" style="background:var(--primary); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Select</button>
                    </td>
                </tr>
            `).join('');

            // সিলেক্ট বক্সে ইউজার লিস্ট যোগ করা
            const select = document.getElementById('target-user');
            users.forEach(user => {
                const opt = document.createElement('option');
                opt.value = user.phone;
                opt.innerText = `${user.name} (${user.phone})`;
                select.appendChild(opt);
            });
        }

        function setTarget(phone) {
            document.getElementById('target-user').value = phone;
            document.getElementById('notif-title').focus();
        }

        async function sendPush() {
            const target = document.getElementById('target-user').value;
            const title = document.getElementById('notif-title').value;
            const body = document.getElementById('notif-body').value;

            if(!title || !body) return alert("Title and Body are required!");

            let notifications = [];

            if (target === "all") {
                // সবাইকে পাঠানোর জন্য লুপ
                notifications = allUsers.map(user => ({
                    receiver_phone: user.phone,
                    sender_name: "Admin",
                    title: title,
                    message: body,
                    type: 'system'
                }));
            } else {
                // পার্সোনাল নোটিফিকেশন
                notifications.push({
                    receiver_phone: target,
                    sender_name: "Admin",
                    title: title,
                    message: body,
                    type: 'system'
                });
            }

            const { error } = await _sb.from('notifications').insert(notifications);

            if (!error) {
                alert(`Successfully sent to ${target === 'all' ? 'all users' : 'the selected user'}!`);
                document.getElementById('notif-title').value = "";
                document.getElementById('notif-body').value = "";
            } else {
                alert("Error sending notification: " + error.message);
            }
        }

        window.onload = initAdmin;
    </script>
</body>
</html>
