<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatMate | Secure Login</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    :root { --primary: #00d2ff; --bg: #020617; --card: #0f172a; --error: #ff4b2b; --success: #00ff88; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: var(--bg); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }

    .card { background: var(--card); padding: 35px; border-radius: 25px; width: 100%; max-width: 400px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
    h2 { text-align: center; color: var(--primary); margin-bottom: 20px; font-weight: 800; letter-spacing: 1px; }

    input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #1e293b; background: #020617; color: white; outline: none; font-size: 15px; transition: 0.3s; text-align: center; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 210, 255, 0.2); }

    .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: #000; font-weight: 800; cursor: pointer; margin-top: 15px; transition: 0.3s; font-size: 15px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); opacity: 0.9; }

    .err-box { background: rgba(255,75,43,0.1); color: var(--error); padding: 15px; border-radius: 12px; font-size: 13px; margin-bottom: 20px; display: none; border: 1px solid rgba(255,75,43,0.2); white-space: pre-line; text-align: left; }

    #loader-overlay { display: none; text-align: center; padding: 20px 0; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin: auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #success-box {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
      background: #0f172a; padding: 30px; border-radius: 20px; text-align: center;
      border: 1px solid var(--success); box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
      display: none; z-index: 1000; opacity: 0; transition: 0.4s;
    }
    #success-box.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  </style>
</head>
<body>

  <div id="success-box">
    <div style="font-size: 40px; margin-bottom: 15px;">üöÄ</div>
    <h3 style="color: var(--success);">Login Successful!</h3>
    <p id="success-msg" style="font-size: 13px; color: #94a3b8; margin-top: 10px;"></p>
  </div>

  <div class="card">
    <div id="main-content">
      <h2>ChatMate Login</h2>
      <div id="err-display" class="err-box"></div>

      <input type="email" id="email" placeholder="Enter Email">
      <input type="password" id="pass" placeholder="Enter Password">
      <button class="btn" id="login-btn" onclick="handleLogin()">LOGIN NOW</button>
      
      <p style="text-align: center; font-size: 13px; margin-top: 20px; color: #64748b;">
        New here? <a href="registration.html" style="color: var(--primary); text-decoration: none;">Create Account</a>
      </p>
    </div>

    <div id="loader-overlay">
      <div class="spinner"></div>
      <p style="color: var(--primary); margin-top: 15px; font-weight: 600;">Verifying...</p>
    </div>
  </div>

  <script>
    async function handleLogin() {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('pass').value.trim();
      const errDisplay = document.getElementById('err-display');
      const loginBtn = document.getElementById('login-btn');

      if (!email || !pass) {
        showError("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®");
        return;
      }

      // UI ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Æ‡ßã‡¶°
      errDisplay.style.display = 'none';
      loginBtn.disabled = true;
      document.getElementById('main-content').style.opacity = '0.3';
      document.getElementById('loader-overlay').style.display = 'block';

      try {
        // ‡ßß. ‡¶∏‡ßÅ‡¶™‡¶æ‡¶¨‡ßá‡¶∏ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶®
        const { data, error } = await _sb.auth.signInWithPassword({
          email: email,
          password: pass,
        });

        if (error) throw error;

        // ‡ß®. ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ
        const { data: profile, error: pError } = await _sb
          .from('users')
          .select('*')
          .eq('phone', email) // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶á ‡¶´‡ßã‡¶® ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá
          .single();

        // ‡ß©. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ (Home ‡¶™‡ßá‡¶ú‡ßá ‡¶ï‡¶æ‡¶ú‡ßá ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)
        localStorage.setItem('user_phone', email);
        if(profile) {
            localStorage.setItem('user_name', profile.name);
        }

        // ‡ß™. ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        document.getElementById('loader-overlay').style.display = 'none';
        const sBox = document.getElementById('success-box');
        document.getElementById('success-msg').innerText = `Welcome back, ${email}`;
        sBox.style.display = 'block';
        setTimeout(() => sBox.classList.add('show'), 10);

        // ‡ß´. ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü
        setTimeout(() => {
          window.location.href = "home.html";
        }, 2000);

      } catch (error) {
        console.error(error);
        let msg = "‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá!";
        
        if(error.message.includes("Invalid login credentials")) {
            msg = "‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§";
        } else if(error.message.includes("Email not confirmed")) {
            msg = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ \nSupabase settings ‡¶•‡ßá‡¶ï‡ßá 'Confirm Email' ‡¶Ö‡¶´ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
        } else {
            msg = error.message;
        }
        
        showError(msg);
        resetUI();
      }
    }

    function showError(msg) {
      const eb = document.getElementById('err-display');
      eb.innerText = msg;
      eb.style.display = 'block';
    }

    function resetUI() {
      document.getElementById('login-btn').disabled = false;
      document.getElementById('main-content').style.opacity = '1';
      document.getElementById('loader-overlay').style.display = 'none';
    }
  </script>
</body>
</html>
